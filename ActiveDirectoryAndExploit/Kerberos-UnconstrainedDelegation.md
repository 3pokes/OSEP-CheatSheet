# Kerberos - Unconstrained Delegation

The Domain Controller (DC) stores the information, about computers configured with unconstrained delegation and makes this information available for all authenticated users.

The information is stored in the userAccountControl property as TRUSTED_FOR_DELEGATION, which is represented with a numerical value of 524288.

1. Use Powerview to enumerate unconstrained delegation.

```PowerShell
Get-DomainComputer -Unconstrained
```

To abuse unconstrained delegation, we must first compromise the computer or service account in question.

When unconstrained delegation is operating normally, the service account hosting the application can freely make use of the forwarded tickets it receives from users.
This means if we compromise the service account as a part of an attack, we can exploit unconstrained delegation without needing local administrative privileges, because we already have access to all affected tickets.

2. Launch Mimikatz from an administrative command prompt and list all tickets present.

```bash
mimikatz # privilege::debug

mimikatz # sekurlsa::tickets
```

Typically, a machine would only be configured with unconstrained delegation because it hosts an application that requires it.

3. If for example there is a website running, we can either wait for a user to connect, or leverage an internal phishing attack to solicit visits.

Since the web application is configured with Windows authentication, the Kerberos protocol is used.
After the user browser has loaded the web page, we use mimikatz and list tickets again, and we should find a TGT for the admin user and it is flagged as forwardable.

4. We can use mimikatz to dump the tickets to disk and then inject the TGT contents from the output file into our process.

```bash
mimikatz # sekurlsa::tickets /export

mimikatz # kerberos::ptt [0;9eaea]-2-0-60a10000-admin@krbtgt-SERV.SINHACK1.COM.kirbi
```

5. With the TGT for the admin user injected into memory, we can exit Mimikatz and test our access on the domain controller with PsExec

```bash
C:\> C:\Tools\SysinternalsSuite\PsExec.exe \\cdc01 cmd

C:\Windows\system32> whoami
prod\admin
```

This illustrates that if a user connects to a service that is configured with unconstrained Kerberos delegtion, that user can be compromised.
